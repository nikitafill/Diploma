@page
@model IndexModel
@{
    ViewData["Title"] = "Извлечение кадра";
}
<h2>@Model.GroupName</h2>

<form method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label>Выберите видеофайл:</label>
        <input type="file" asp-for="VideoFile" class="form-control" accept="video/*" onchange="previewVideo(event)" />
    </div>
    <div class="mb-3" id="videoPreviewContainer" style="display: none;">
        <label>Предпросмотр видео:</label>
        <video id="videoPreview" controls width="100%" class="border rounded"></video>
    </div>

    <div class="mb-3">
        <label>Начальная точка (в секундах):</label>
        <input type="number" asp-for="StartTime" class="form-control"/>
    </div>

    <div class="mb-3">
        <label>Шаг между кадрами (секунды):</label>
        <input type="number" asp-for="TimeStep" class="form-control" placeholder="Оставьте пустым для одного кадра" />
    </div>

    <button type="submit" class="btn btn-primary">Извлечь кадры</button>
</form>

@if (Model.ExtractedFrames?.Count > 0)
{
    var i = 0;
    <h3>Эксперименты группы:</h3>
    <div class="row">
        @foreach (var frame in Model.ExtractedFrames)
        {
            i++;
            <div class="col-md-4 mb-3">
                <div class="card">
                    <img src="@frame.FrameUrl" class="card-img-top" />
                    <h4 class="text-center">Эксперимент @i</h4>
                    <div class="card-body text-center">
                        <a class="btn btn-sm btn-primary" href="/Analyze?id=@frame.Id">Анализировать</a>
                    </div>
                </div>
            </div>
        }
    </div>
}
@if ( Model.GroupFrames?.Count > 0)
{
    var i = 0;
    <h3>Эксперименты группы:</h3>
    <div class="row">
        @foreach (var frame in Model.GroupFrames)
        {
            i++;
            <div class="col-md-4 mb-3">
                <div class="card">
                    <img src="@frame.FrameUrl" class="card-img-top" />
                    <h4 class="text-center">Эксперимент @i</h4>
                    <div class="card-body text-center">
                        <a class="btn btn-sm btn-primary"
                           href="/Analyze?id=@frame.Id&groupId=@Model.GroupId">
                            Анализировать
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
}
@if (Model.GroupQuestions?.Count > 0)
{
    <h3>Вопросы</h3>
    @foreach (var question in Model.GroupQuestions)
    {
        var userAnswer = Model.Answers.FirstOrDefault(a => a.QuestionId == question.Id);
        <div class="mb-3 border p-3 rounded">
            <p><strong>Вопрос:</strong> @question.Text</p>

            @if (userAnswer is not null)
            {
                <div class="mt-2 p-2 border bg-light rounded">
                    <strong>Ваш ответ:</strong>
                    <p>@userAnswer.Answer</p>
                </div>
            }
            else
            {
                <button type="button" class="btn btn-primary mb-2" onclick="toggleForm(this)">Ответить</button>

                <div class="answerFormBlock" style="display: none;">
                    <form method="post" asp-page-handler="Add" onsubmit="return confirmSubmit();">
                        <input type="hidden" name="NewAnswer.QuestionId" value="@question.Id" />
                        <input type="hidden" name="NewAnswer.ExperimentGroupId" value="@Model.GroupId" />
                        <textarea name="NewAnswer.Answer" class="form-control mb-2" rows="3" placeholder="Введите ваш ответ..." required></textarea>
                        <div>
                            <button type="submit" class="btn btn-success me-2">Подтвердить</button>
                            <button type="button" class="btn btn-secondary" onclick="toggleForm(this)">Отмена</button>
                        </div>
                    </form>
                </div>
            }
        </div>
    }
}

<script>
    function previewVideo(event) {
        const file = event.target.files[0];
        const video = document.getElementById('videoPreview');
        const container = document.getElementById('videoPreviewContainer');

        if (file) {
            const url = URL.createObjectURL(file);
            video.src = url;
            container.style.display = "block";
        } else {
            video.src = "";
            container.style.display = "none";
        }
    }
</script>
<script>
    function toggleForm(button) {
        const container = button.closest('.mb-3');
        const formBlock = container.querySelector('.answerFormBlock');
        const answerBtn = container.querySelector('.btn-primary');

        const isVisible = formBlock.style.display === 'block';

        if (!isVisible) {
            formBlock.style.display = 'block';
            answerBtn.style.display = 'none';
        } else {
            formBlock.style.display = 'none';
            answerBtn.style.display = 'inline-block';
        }
    }

    function confirmSubmit() {
        return confirm("После подтверждения изменить ответ будет невозможно. Продолжить?");
    }
</script>

@{/*<script>
    function showAnswerInput(button) {
        const container = button.closest(".mb-3");
        container.querySelector(".initialButtonBlock").style.display = 'none';
        container.querySelector(".answerFormBlock").style.display = 'block';
    }

    function cancelAnswer(button) {
        const container = button.closest(".mb-3");
        container.querySelector("textarea").value = '';
        container.querySelector(".answerFormBlock").style.display = 'none';
        container.querySelector(".initialButtonBlock").style.display = 'block';
    }

    function submitAnswer(button) {
        const container = button.closest(".mb-3");
        const answer = container.querySelector("textarea").value;

        if (answer.trim() === "") {
            alert("Пожалуйста, введите ответ.");
            return;
        }

        alert("Ответ отправлен: " + answer);
        cancelAnswer(button);
    }
</script>*/}
